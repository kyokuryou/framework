<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="web_all" name="framework_web">

    <import file="./build_property.xml"/>
    <path id="web_compile.classpath">
        <path refid="jar.files"/>
        <file file="${src.build.dirPath}/${src.jar.name}.jar"/>
    </path>
    <patternset id="files_filter">
        <patternset refid="ignored.files"/>
        <patternset refid="resource.files"/>
    </patternset>
    <!-- resources用于实现对资源文件和配置文件的部署 -->
    <target name="web_resources">
        <copy todir="${web.build.dirPath}" overwrite="true">
            <fileset dir="${web.dirPath}">
                <patternset refid="files_filter"/>
            </fileset>
        </copy>
    </target>

    <target name="web_compile" depends="web_prepare,web_resources">
        <mkdir dir="${web.build.dirPath}"/>
        <javac fork="true" includeAntRuntime="false" srcdir="${web.dirPath}" executable="${target.java.home}/bin/javac"
               target="${target.java.version}" destdir="${web.build.dirPath}"
               debug="true" debuglevel="source,lines,vars">
            <compilerarg line="-encoding ${target.encode}"/>
            <compilerarg value="-Xlint:unchecked"/>
            <compilerarg value="-Xlint:deprecation"/>
            <classpath refid="web_compile.classpath"/>
        </javac>
    </target>

    <target name="web_prepare">
        <tstamp/>
    </target>

    <target name="web_clean" description="Prepare for clean build">
        <!--<delete dir="${web.build.dirPath}"/>-->
        <!--<delete dir="${war.web.dirPath}/WEB-INF/lib/${web.jar.name}.jar"/>-->
        <delete>
            <fileset dir="${war.web.dirPath}">
                <include name="core/css/**"/>
                <include name="core/images/**"/>
                <include name="core/js/**"/>
                <patternset refid="ignored.files"/>
            </fileset>
            <fileset dir="${war.web.dirPath}/WEB-INF">
                <include name="core/inc/**"/>
                <include name="core/error_page.ftl"/>
                <include name="web.xml"/>
                <patternset refid="ignored.files"/>
            </fileset>
        </delete>
    </target>
    <target name="web_dist" description="Create binary distribution">
        <jar jarfile="${web.build.dirPath}/${web.jar.name}.jar" basedir="${web.build.dirPath}">
            <exclude name="**/*.jar"/>
            <exclude name="**/*.zip"/>
            <manifest>
                <attribute name="Specification-Title" value="${component.name}"/>
                <attribute name="Specification-Version" value="${component.Version}"/>
                <attribute name="Specification-Vendor" value="${component.Vendor}"/>
                <attribute name="Implementation-Title" value="${component.name}"/>
                <attribute name="Implementation-Version" value="${component.Version}"/>
                <attribute name="X-Compile-Target-JDK" value="${target.java.version}"/>
                <attribute name="X-Compile-Source-JDK" value="${target.java.version}"/>
            </manifest>
        </jar>
    </target>
    <target name="web_zip_dist" description="Create Source distribution">
        <zip destfile="${web.build.dirPath}/${web.jar.name}.zip">
            <fileset dir="${web.dirPath}">
                <include name="**/*.java"/>
                <patternset refid="resource.files"/>
                <patternset refid="ignored.files"/>
            </fileset>
        </zip>
    </target>

    <target name="web_copy">
        <!-- web基础 -->
        <mkdir dir="${war.web.dirPath}/core"/>
        <mkdir dir="${war.web.dirPath}/core/css"/>
        <mkdir dir="${war.web.dirPath}/core/js"/>
        <mkdir dir="${war.web.dirPath}/core/images"/>
        <mkdir dir="${war.web.dirPath}/WEB-INF/core"/>
        <mkdir dir="${war.web.dirPath}/WEB-INF/core/inc"/>

        <copy todir="${war.web.dirPath}/WEB-INF/lib" overwrite="true">
            <fileset dir="${web.build.dirPath}">
                <include name="${web.jar.name}.jar"/>
            </fileset>
        </copy>
        <copy todir="${war.web.dirPath}/core" overwrite="true" includeEmptyDirs="no">
            <fileset dir="${web.web.dirPath}/core">
                <include name="css/**"/>
                <include name="js/**"/>
                <include name="images/**"/>
                <patternset refid="ignored.files"/>
            </fileset>
        </copy>
        <!-- WEB-INF 基础结构 -->
        <copy todir="${war.web.dirPath}/WEB-INF/core" overwrite="true" includeEmptyDirs="no">
            <fileset dir="${web.web.dirPath}/WEB-INF/core">
                <include name="inc/**"/>
                <patternset refid="ignored.files"/>
            </fileset>
        </copy>

        <copy todir="${war.src.dirPath}" overwrite="true">
            <fileset dir="${web.meta.dirPath}/src">
                <include name="spring-web.xml"/>
                <include name="web.local.properties"/>
            </fileset>
        </copy>
        <copy todir="${war.web.dirPath}/WEB-INF" overwrite="true">
            <fileset dir="${web.meta.dirPath}/web">
                <include name="web.xml"/>
                <!-- 权限 -->
                <!--<include name="web-security.xml"/>-->
            </fileset>
        </copy>

        <!--<move file="${war.web.dirPath}/WEB-INF/web-security.xml" tofile="${war.web.dirPath}/WEB-INF/web.xml"/>-->
        <!-- Flex支持 -->
        <!--
        <mkdir dir="${war.webInfo.dirPath}/flex"/>
        <copy todir="${war.webInfo.dirPath}/flex" overwrite="true" includeEmptyDirs="no">
            <fileset dir="${web.webInfo.dirPath}/flex">
                <patternset refid="ignored.files"/>
            </fileset>
        </copy>
        -->
    </target>

    <target name="web_project" depends="web_clean,web_prepare,web_compile"/>

    <target name="web_all" depends="web_project,web_dist,web_zip_dist,web_copy"/>
</project>